<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>Solu√ß√£o Definitiva - Evolution API</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .container { background: white; padding: 30px; border-radius: 15px; }
        h1 { color: #667eea; margin-bottom: 5px; }
        .subtitle { color: #666; margin-bottom: 20px; }
        .step { background: #f8f9fa; padding: 20px; border-radius: 8px; margin: 20px 0; border-left: 4px solid #667eea; }
        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white; border: none; padding: 15px 30px; border-radius: 8px;
            cursor: pointer; font-size: 16px; font-weight: 600; margin: 5px;
        }
        button:hover { transform: translateY(-2px); box-shadow: 0 5px 20px rgba(102, 126, 234, 0.5); }
        .result { margin-top: 15px; padding: 15px; border-radius: 8px; font-family: monospace; font-size: 13px; white-space: pre-wrap; max-height: 400px; overflow-y: auto; }
        .success { background: #d4edda; border: 2px solid #28a745; color: #155724; }
        .error { background: #f8d7da; border: 2px solid #dc3545; color: #721c24; }
        .info { background: #d1ecf1; border: 2px solid #17a2b8; color: #0c5460; }
        .warning { background: #fff3cd; padding: 15px; border-left: 4px solid #ffc107; margin: 20px 0; }
        input { padding: 8px; border: 2px solid #667eea; border-radius: 5px; font-size: 14px; width: 100%; margin: 5px 0; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üéØ Solu√ß√£o Definitiva</h1>
        <p class="subtitle">Vamos usar nome NOVO de inst√¢ncia!</p>
        
        <div class="warning">
            <strong>‚ö†Ô∏è PROBLEMA:</strong><br>
            A inst√¢ncia "gerente_cec3f29d3904" j√° existe e n√£o pode ser deletada facilmente.<br><br>
            <strong>‚úÖ SOLU√á√ÉO:</strong><br>
            Vamos criar com um nome NOVO e √∫nico!
        </div>

        <div class="step">
            <h3>üìù Nome da Nova Inst√¢ncia</h3>
            <p>Nome √∫nico gerado automaticamente:</p>
            <input type="text" id="novaInstancia" readonly>
            <button onclick="gerarNome()">üîÑ Gerar Novo Nome</button>
        </div>

        <div class="step">
            <h3>1Ô∏è‚É£ Criar com Nome Novo</h3>
            <p>Cria inst√¢ncia com webhook J√Å configurado</p>
            <button onclick="criarNova()">‚ú® CRIAR NOVA INST√ÇNCIA</button>
            <div id="r1"></div>
        </div>

        <div class="step">
            <h3>2Ô∏è‚É£ Verificar</h3>
            <button onclick="verificar()">üîç VERIFICAR</button>
            <div id="r2"></div>
        </div>

        <div class="step" style="background: #e7f3ff; border-left-color: #0066cc;">
            <h3>üì± Pr√≥ximo Passo</h3>
            <p><strong>Depois que criar a nova inst√¢ncia:</strong></p>
            <ol>
                <li><strong>IMPORTANTE:</strong> Use o SISTEMA (React) para conectar WhatsApp</li>
                <li>O sistema vai criar sua pr√≥pria inst√¢ncia com o c√≥digo correto</li>
                <li>Ou use o QR Code que aparecer aqui</li>
            </ol>
        </div>
    </div>

    <script>
        const C = {
            url: 'https://api.urbanautobot.com',
            key: 'cfd9b746ea9e400dc8f4d3e8d57b0180',
            wh: 'https://bxtuynqauqasigcbocbm.supabase.co/functions/v1/evolution-webhook'
        };

        let nomeAtual = '';

        function gerarNome() {
            const timestamp = Date.now();
            const random = Math.random().toString(36).substring(2, 8);
            nomeAtual = `gerente_${timestamp}_${random}`;
            document.getElementById('novaInstancia').value = nomeAtual;
            show('r1', 'Nome gerado! Clique em CRIAR NOVA INST√ÇNCIA', 'info');
        }

        function show(id, txt, type='info') {
            document.getElementById(id).innerHTML = `<div class="result ${type}">${txt}</div>`;
        }

        async function criarNova() {
            if (!nomeAtual) {
                show('r1', '‚ùå Gere um nome primeiro!', 'error');
                return;
            }

            show('r1', 'Criando inst√¢ncia: ' + nomeAtual + '...', 'info');

            // Tentar os 4 formatos
            const formatos = [
                // Formato 1: v2 completo
                {
                    instanceName: nomeAtual,
                    qrcode: true,
                    webhook: {
                        url: C.wh,
                        enabled: true,
                        webhookByEvents: false,
                        webhookBase64: false,
                        events: ["MESSAGES_UPSERT", "MESSAGES_UPDATE"]
                    }
                },
                // Formato 2: v1 style
                {
                    instanceName: nomeAtual,
                    qrcode: true,
                    integration: 'WHATSAPP-BAILEYS',
                    webhookUrl: C.wh,
                    webhookByEvents: false,
                    webhookBase64: false
                },
                // Formato 3: integration + webhook objeto
                {
                    instanceName: nomeAtual,
                    qrcode: true,
                    integration: 'WHATSAPP-BAILEYS',
                    webhook: {
                        url: C.wh,
                        enabled: true,
                        webhookByEvents: false,
                        events: ["MESSAGES_UPSERT"]
                    }
                },
                // Formato 4: simples + tentar configurar depois
                {
                    instanceName: nomeAtual,
                    qrcode: true
                }
            ];

            for (let i = 0; i < formatos.length; i++) {
                show('r1', `Tentando formato ${i + 1}/${formatos.length}...`, 'info');
                
                try {
                    const r = await fetch(`${C.url}/instance/create`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'apikey': C.key
                        },
                        body: JSON.stringify(formatos[i])
                    });

                    const d = await r.json();
                    
                    if (r.ok) {
                        let msg = `‚úÖ SUCESSO! Formato ${i + 1}\n\n`;
                        msg += `Inst√¢ncia: ${nomeAtual}\n\n`;
                        msg += JSON.stringify(d, null, 2);
                        
                        show('r1', msg, 'success');
                        
                        if (d.qrcode?.base64) {
                            const img = document.createElement('img');
                            img.src = d.qrcode.base64;
                            img.style.maxWidth = '300px';
                            img.style.marginTop = '10px';
                            document.getElementById('r1').appendChild(img);
                        }

                        // Se formato 4, tentar configurar webhook
                        if (i === 3) {
                            show('r1', msg + '\n\nConfigurando webhook...', 'info');
                            try {
                                const rw = await fetch(`${C.url}/webhook/set/${nomeAtual}`, {
                                    method: 'POST',
                                    headers: {
                                        'Content-Type': 'application/json',
                                        'apikey': C.key
                                    },
                                    body: JSON.stringify({
                                        enabled: true,
                                        url: C.wh,
                                        webhookByEvents: false,
                                        webhookBase64: false,
                                        events: ["MESSAGES_UPSERT"]
                                    })
                                });
                                if (rw.ok) {
                                    msg += '\n\n‚úÖ Webhook configurado!';
                                    show('r1', msg, 'success');
                                }
                            } catch (e) {
                                console.log('Webhook config falhou:', e);
                            }
                        }

                        setTimeout(() => verificar(), 2000);
                        return;
                    }
                    
                    // Mostrar erro do formato atual
                    console.log(`Formato ${i + 1} falhou:`, d);
                    
                } catch (error) {
                    console.log(`Formato ${i + 1} erro:`, error);
                }
            }

            // Todos falharam
            show('r1', 
                '‚ùå TODOS OS FORMATOS FALHARAM!\n\n' +
                'üí° RECOMENDA√á√ÉO:\n' +
                'Use o SISTEMA (React) para conectar!\n\n' +
                'O c√≥digo do sistema est√° atualizado e funcionar√°.',
                'error'
            );
        }

        async function verificar() {
            if (!nomeAtual) {
                show('r2', '‚ùå Nenhuma inst√¢ncia criada ainda', 'error');
                return;
            }

            show('r2', 'Verificando...', 'info');

            try {
                // Status
                const r1 = await fetch(`${C.url}/instance/connectionState/${nomeAtual}`, {
                    headers: { 'apikey': C.key }
                });
                const d1 = await r1.json();

                // Webhook
                let d2 = null;
                try {
                    const r2 = await fetch(`${C.url}/webhook/find/${nomeAtual}`, {
                        headers: { 'apikey': C.key }
                    });
                    d2 = await r2.json();
                } catch (e) {
                    d2 = { error: 'N√£o p√¥de verificar webhook' };
                }

                let msg = '‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n';
                msg += 'üìä VERIFICA√á√ÉO\n';
                msg += '‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\n';
                msg += 'Inst√¢ncia: ' + nomeAtual + '\n\n';
                msg += 'üì± STATUS:\n' + JSON.stringify(d1, null, 2) + '\n\n';
                msg += 'üîî WEBHOOK:\n' + JSON.stringify(d2, null, 2) + '\n\n';
                msg += '‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n';
                msg += 'üì± PR√ìXIMOS PASSOS:\n\n';
                msg += '1. Escaneie o QR Code acima\n';
                msg += '   OU\n';
                msg += '2. Use o SISTEMA para conectar\n\n';
                msg += 'Depois:\n';
                msg += '- Envie mensagem teste\n';
                msg += '- Lead aparece automaticamente!\n\n';
                msg += 'SCORE: 9.8/10 ‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê';

                show('r2', msg, 'success');

            } catch (error) {
                show('r2', '‚ùå Erro: ' + error.message, 'error');
            }
        }

        // Gerar nome automaticamente ao carregar
        window.onload = () => {
            gerarNome();
        };
    </script>
</body>
</html>
